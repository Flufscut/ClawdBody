generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String        @id @default(cuid())
  name          String?
  email         String?       @unique
  emailVerified DateTime?
  image         String?
  
  // Pro Subscription
  isPro                Boolean   @default(false)
  stripeCustomerId     String?
  stripeSubscriptionId String?

  accounts      Account[]
  sessions      Session[]
  setup         SetupState?
  integrations  Integration[]
  vms           VM[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model SetupState {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Setup progress
  status String @default("pending") // pending, provisioning, configuring_vm, ready, failed

  // VM Provider selection
  vmProvider String? // orgo, aws, flyio

  // LLM API Key (encrypted, auto-detected provider)
  llmApiKey    String?  // Any provider's API key (Anthropic, OpenRouter, OpenAI, etc.)
  llmProvider  String?  // Auto-detected: anthropic, openrouter, openai, google, groq, xai, perplexity, fireworks, cohere
  llmModel     String?  // Model ID: e.g., "claude-sonnet-4", "gpt-4o", "openai/gpt-oss-120b:free"
  
  // VM Provider API Keys (encrypted)
  orgoApiKey   String?

  // AWS Credentials (encrypted in production)
  awsAccessKeyId     String?
  awsSecretAccessKey String?
  awsRegion          String? @default("us-east-1")
  awsInstanceType    String? @default("m7i-flex.large")

  // E2B Credentials
  e2bApiKey          String?

  // Orgo VM info
  orgoProjectId   String?
  orgoProjectName String?
  orgoComputerId  String?
  orgoComputerUrl String?
  vmStatus        String? // creating, starting, running, stopped

  // AWS EC2 instance info
  awsInstanceId   String?
  awsInstanceName String?
  awsPublicIp     String?
  awsPrivateKey   String?

  // Setup steps completed
  vmCreated          Boolean @default(false)
  clawdbotInstalled  Boolean @default(false)
  telegramConfigured Boolean @default(false)
  gatewayStarted     Boolean @default(false)

  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VM {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // VM Info
  name     String
  provider String  // orgo, aws, flyio, etc.
  status   String  @default("pending") // pending, creating, running, stopped, error

  // Orgo specific fields
  orgoProjectId   String?
  orgoProjectName String?
  orgoComputerId  String?
  orgoComputerUrl String?
  orgoRam         Int?     @default(4)  // RAM in GB: 1, 2, 4, 8, 16, 32, or 64
  orgoCpu         Int?     @default(2)  // CPU cores: 1, 2, 4, 8, or 16

  // AWS specific fields
  awsInstanceId   String?
  awsInstanceName String?
  awsInstanceType String?
  awsRegion       String?
  awsPublicIp     String?
  awsPrivateKey   String?

  // E2B specific fields
  e2bSandboxId    String?
  e2bTemplateId   String?
  e2bTimeout      Int?     @default(3600) // Timeout in seconds

  // SSH connection info
  sshHost     String?
  sshPort     Int?     @default(22)
  sshUser     String?
  sshKeyPath  String?

  // Setup state for this VM
  vmCreated          Boolean @default(false)
  clawdbotInstalled  Boolean @default(false)
  telegramConfigured Boolean @default(false)
  gatewayStarted     Boolean @default(false)

  errorMessage String?

  // Chat messages for this VM
  chatMessages ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Chat messages for Clawdbot conversations
model ChatMessage {
  id        String   @id @default(cuid())
  
  // Can be associated with a specific VM or just a user
  vmId      String?
  vm        VM?      @relation(fields: [vmId], references: [id], onDelete: Cascade)
  
  userId    String
  sessionId String   // For grouping messages in a conversation
  
  role      String   // 'user', 'assistant', 'error'
  content   String   @db.Text // Use Text for longer messages
  
  createdAt DateTime @default(now())
  
  @@index([userId, sessionId])
  @@index([vmId])
}

model Integration {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Integration info
  provider     String // gmail, calendar, slack, etc.
  status       String    @default("connected") // connected, disconnected, error
  lastSyncedAt DateTime?
  syncEnabled  Boolean   @default(true)

  // Metadata (JSON for flexibility)
  metadata String? // JSON string for provider-specific data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, provider])
}

// Template Marketplace - User-uploaded templates
// Built-in templates are defined in code (src/lib/templates.ts)
model MarketplaceTemplate {
  id          String   @id @default(cuid())
  
  // Template identification
  templateId  String   @unique  // Unique slug like "my-agent-template"
  name        String
  description String   @db.Text
  logo        String?            // URL to logo image
  category    String             // social, productivity, dev-tools, other
  
  // Author info
  authorId    String?            // User who uploaded (null for built-in)
  authorName  String?
  
  // VM configuration (stored as JSON)
  vmConfig    String   @db.Text  // JSON: { provider, minRam, recommendedRam }
  
  // Setup configuration (stored as JSON)
  setup       String   @db.Text  // JSON: { commands: string[] }
  
  // Optional registration API (stored as JSON)
  registration String? @db.Text  // JSON: { endpoint, method, headers, bodyTemplate, responseMapping }
  
  // Optional credentials config (stored as JSON)
  credentials String?  @db.Text  // JSON: { path, template }
  
  // Post-setup config (stored as JSON)
  postSetup   String?  @db.Text  // JSON: { type, message }
  
  // Metadata
  websiteUrl  String?
  isPublic    Boolean  @default(false)  // Whether visible to all users
  isVerified  Boolean  @default(false)  // Reviewed and approved
  
  // Stats
  deployCount Int      @default(0)
  shareCount  Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  events      TemplateEvent[]
  
  @@index([category])
  @@index([authorId])
  @@index([isPublic, isVerified])
  @@index([deployCount])
  @@index([shareCount])
}

// Template Events - Track deployments, shares, and other interactions
model TemplateEvent {
  id          String   @id @default(cuid())
  
  // Template (can be user-created or built-in)
  templateId  String              // The template slug (e.g., "moltbook", "personal-assistant-xyz")
  isBuiltIn   Boolean  @default(false) // True if this is a built-in template
  
  // User who performed the action
  userId      String?             // Null for anonymous actions (shares from non-logged-in users)
  userName    String?
  
  // Event type
  eventType   String              // "deploy", "share", "view", "click"
  
  // Additional metadata (JSON)
  metadata    String?  @db.Text   // JSON: { shareMethod: "twitter", vmProvider: "orgo", etc }
  
  createdAt   DateTime @default(now())
  
  // Relations
  template    MarketplaceTemplate? @relation(fields: [templateId], references: [templateId])
  
  @@index([templateId])
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
}
